<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Auditoria Hospitalar ¬∑ Painel Executivo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
    }

    :root {
      --bg: #0a0f1a;
      --surface: rgba(18, 25, 40, 0.85);
      --surface-hover: rgba(30, 40, 60, 0.9);
      --border: rgba(72, 85, 106, 0.35);
      --text-primary: #f0f3fa;
      --text-secondary: #a6b3cf;
      --accent-emerald: #2dd4bf;
      --accent-blue: #3b82f6;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --chart-1: #2dd4bf;
      --chart-2: #3b82f6;
      --chart-3: #f59e0b;
      --gradient-1: linear-gradient(145deg, rgba(45,212,191,0.15) 0%, rgba(59,130,246,0.1) 100%);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.5;
      padding: 1.5rem;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(45,212,191,0.08) 0%, transparent 35%),
        radial-gradient(circle at 90% 70%, rgba(59,130,246,0.08) 0%, transparent 40%),
        radial-gradient(circle at 30% 80%, rgba(245,158,11,0.05) 0%, transparent 45%);
    }

    .dashboard {
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Header com filtro */
    .header {
      background: rgba(18, 25, 40, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 2rem;
      padding: 1.5rem 2rem;
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      box-shadow: 0 20px 35px -10px rgba(0,0,0,0.5);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 52px;
      height: 52px;
      background: var(--gradient-1);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.5rem;
      border: 1px solid rgba(45,212,191,0.4);
      color: var(--accent-emerald);
    }

    .title h1 {
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #fff, #b0c4de);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      background: rgba(0,0,0,0.25);
      padding: 0.5rem;
      border-radius: 3rem;
      border: 1px solid var(--border);
    }

    .filter-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem 1.2rem;
      border-radius: 2rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .filter-btn.active {
      background: var(--accent-emerald);
      color: #0a0f1a;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(45,212,191,0.4);
    }

    /* Cards de KPI */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .kpi-card {
      background: rgba(18, 25, 40, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 1.5rem 1.2rem;
      transition: transform 0.1s, background 0.2s;
    }

    .kpi-card:hover {
      background: rgba(30, 40, 60, 0.8);
      transform: translateY(-2px);
    }

    .kpi-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 0.25rem;
    }

    .kpi-trend {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .badge {
      background: rgba(45,212,191,0.2);
      color: var(--accent-emerald);
      border-radius: 2rem;
      padding: 0.2rem 0.8rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* Se√ß√µes */
    .section {
      background: rgba(18, 25, 40, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 2rem;
      padding: 1.8rem;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .section-sub {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }

    /* Tabelas modernas */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 1.2rem;
      background: rgba(0,0,0,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      text-align: left;
      padding: 1rem 1rem 0.8rem 1rem;
      color: var(--text-secondary);
      font-weight: 500;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid rgba(72,85,106,0.2);
    }

    td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .progress-bar {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .bar {
      height: 8px;
      background: var(--accent-emerald);
      border-radius: 4px;
      min-width: 4px;
    }

    .bar-bg {
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
    }

    /* Destaque comparativo */
    .compare-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .compare-card {
      background: rgba(0,0,0,0.3);
      border-radius: 1.5rem;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .compare-card h3 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--accent-amber);
    }

    .compare-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .metric small {
      color: var(--text-secondary);
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    .metric .value {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .callout {
      background: rgba(245,158,11,0.12);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 1.2rem;
      padding: 1.2rem;
      margin-top: 1rem;
      color: #fcd34d;
    }

    .footer {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-top: 2rem;
    }

    @media (max-width: 900px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="dashboard">

  <!-- Cabe√ßalho com filtro -->
  <div class="header">
    <div class="brand">
      <div class="logo">AH</div>
      <div class="title">
        <h1>Auditoria Executiva</h1>
        <p>Base: 1.017 prontu√°rios ¬∑ 4.885 erros ¬∑ SQLite</p>
      </div>
    </div>
    <div class="filter-bar" id="monthFilter">
      <button class="filter-btn active" data-month="all">Todos</button>
      <button class="filter-btn" data-month="2025-10">Out/25</button>
      <button class="filter-btn" data-month="2025-11">Nov/25</button>
      <button class="filter-btn" data-month="2025-12">Dez/25</button>
      <button class="filter-btn" data-month="2026-01">Jan/26</button>
      <button class="filter-btn" data-month="2026-02">Fev/26</button>
    </div>
  </div>

  <!-- KPIs principais com totais filtrados (atualizados via JS) -->
  <div class="kpi-grid" id="kpiMain">
    <div class="kpi-card">
      <div class="kpi-label">üìã Prontu√°rios</div>
      <div class="kpi-value" id="kpiProntuarios">1.017</div>
      <div class="kpi-trend">Total na base</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">‚ö†Ô∏è Pront. com erro</div>
      <div class="kpi-value" id="kpiComErro">940</div>
      <div class="kpi-trend">92,4% do total</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">üî¥ Total de erros</div>
      <div class="kpi-value" id="kpiErros">4.885</div>
      <div class="kpi-trend">m√©dia 4,8 / pront.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">üìä Erros por pront.</div>
      <div class="kpi-value" id="kpiErrosPorPront">4,80</div>
      <div class="kpi-trend">m√©dia geral</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">‚è±Ô∏è SLA (mediana)</div>
      <div class="kpi-value" id="kpiSla">8,0</div>
      <div class="kpi-trend">dias alta ‚Üí fat.</div>
    </div>
  </div>

  <!-- Filtro ativo - totais din√¢micos -->
  <div class="section" style="padding: 1rem 1.8rem;">
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
      <div><span class="badge" style="background:rgba(59,130,246,0.2); color:#3b82f6;">üìÅ Filtro atual: <span id="filtroNome">Todos os meses</span></span></div>
      <div><span class="badge" style="background:rgba(45,212,191,0.2); color:#2dd4bf;">üìä Per√≠odo filtrado: <span id="filtroPront">1.017</span> pront. ¬∑ <span id="filtroErr">4.885</span> erros</span></div>
    </div>
  </div>

  <!-- Comparativo mensal (din√¢mico) -->
  <div class="section">
    <h2 class="section-title">Comparativo executivo</h2>
    <p class="section-sub">M√™s selecionado vs. m√™s anterior</p>
    <div class="compare-cards" id="compareContainer">
      <!-- preenchido via JS -->
    </div>
    <div class="callout" id="calloutCompare">
      <b>Leitura r√°pida:</b> de Dez/2025 para Jan/2026, houve varia√ß√£o de <b>-946</b> erros e redu√ß√£o no volume, com aumento de +4,23 p.p. na taxa de prontu√°rios com erro.
    </div>
  </div>

  <!-- Tend√™ncia mensal + SLAs -->
  <div class="grid-2">
    <div class="section">
      <h2 class="section-title">üìà Tend√™ncia mensal</h2>
      <p class="section-sub">Prontu√°rios e erros (clique no filtro para detalhar)</p>
      <div class="table-wrapper">
        <table id="trendTable">
          <thead>
            <tr><th>M√™s</th><th class="num">Pront.</th><th class="num">c/ erro</th><th class="num">Erros</th><th class="num">Erros/pront.</th></tr>
          </thead>
          <tbody>
            <tr data-month="2025-10"><td>2025-10</td><td class="num">87</td><td class="num">87</td><td class="num">438</td><td class="num">5,03</td></tr>
            <tr data-month="2025-11"><td>2025-11</td><td class="num">182</td><td class="num">153</td><td class="num">643</td><td class="num">3,53</td></tr>
            <tr data-month="2025-12"><td>2025-12</td><td class="num">348</td><td class="num">313</td><td class="num">2.125</td><td class="num">6,11</td></tr>
            <tr data-month="2026-01"><td>2026-01</td><td class="num">206</td><td class="num">194</td><td class="num">1.179</td><td class="num">5,72</td></tr>
            <tr data-month="2026-02"><td>2026-02</td><td class="num">16</td><td class="num">15</td><td class="num">72</td><td class="num">4,50</td></tr>
          </tbody>
        </table>
      </div>
      <!-- mini barras de tend√™ncia (visual) -->
      <div style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">
        <span style="color:var(--text-secondary);">Erros:</span>
        <div style="flex:1; display:flex; gap:2px; height:40px; align-items:flex-end;">
          <div style="flex:1; background:#2dd4bf; height:calc(438/2125*40px); min-height:4px; border-radius:4px 4px 0 0;"></div>
          <div style="flex:1; background:#2dd4bf; height:calc(643/2125*40px); min-height:4px;"></div>
          <div style="flex:1; background:#2dd4bf; height:40px;"></div>
          <div style="flex:1; background:#2dd4bf; height:calc(1179/2125*40px);"></div>
          <div style="flex:1; background:#2dd4bf; height:calc(72/2125*40px);"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">‚è±Ô∏è SLAs & tempos</h2>
      <p class="section-sub">Mediana em dias (dados consistentes)</p>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>M√©trica</th><th class="num">Mediana</th><th class="num">M√©dia</th><th>P90</th></tr></thead>
          <tbody>
            <tr><td>Perman√™ncia (alta ‚àí admiss√£o)</td><td class="num">1,0</td><td class="num">1,3</td><td class="num">1,0</td></tr>
            <tr><td>Recebimento ‚Üí Fim auditoria</td><td class="num">1,0</td><td class="num">2,1</td><td class="num">4,0</td></tr>
            <tr><td>Fim auditoria ‚Üí Envio fat.</td><td class="num">0,0</td><td class="num">0,0</td><td class="num">0,0</td></tr>
            <tr><td>Alta ‚Üí Envio faturamento</td><td class="num">8,0</td><td class="num">9,6</td><td class="num">16,0</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Setor / Conv√™nio / Tipo (cards) -->
  <div class="grid-3">
    <div class="section">
      <h3 class="section-title" style="font-size:1.2rem;">üè• Erros por setor</h3>
      <div class="table-wrapper">
        <table>
          <tr><th>Setor</th><th class="num">Erros</th></tr>
          <tr><td>INTERNA√á√ÉO / CC</td><td class="num">4.547</td></tr>
          <tr><td>INTERNA√á√ÉO / CLINICA</td><td class="num">338</td></tr>
        </table>
      </div>
    </div>
    <div class="section">
      <h3 class="section-title" style="font-size:1.2rem;">üè• Top conv√™nios</h3>
      <div class="table-wrapper" style="max-height:200px; overflow-y:auto;">
        <table>
          <thead><tr><th>Conv√™nio</th><th class="num">Erros</th></tr></thead>
          <tbody>
            <tr><td>UNIMED</td><td class="num">3.776</td></tr>
            <tr><td>UNIMED / INTERC√ÇMBIO</td><td class="num">517</td></tr>
            <tr><td>MAIS SAUDE</td><td class="num">365</td></tr>
            <tr><td>SUL AMERICA</td><td class="num">95</td></tr>
            <tr><td>CASSI</td><td class="num">46</td></tr>
            <tr><td>BRADESCO</td><td class="num">23</td></tr>
            <tr><td>VIVACOM</td><td class="num">21</td></tr>
            <tr><td>AFFEGO</td><td class="num">16</td></tr>
            <tr><td>UNIMED/ INTERCAMBIO</td><td class="num">8</td></tr>
            <tr><td>FUSEX</td><td class="num">6</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <h3 class="section-title" style="font-size:1.2rem;">üìå Tipos de erro</h3>
      <div class="table-wrapper">
        <table>
          <tr><th>Tipo</th><th class="num">Erros</th></tr>
          <tr><td>ERRO FATURAMENTO</td><td class="num">3.627</td></tr>
          <tr><td>ERRO ENFERMAGEM</td><td class="num">934</td></tr>
          <tr><td>ERRO M√âDICO</td><td class="num">199</td></tr>
          <tr><td>ERRO RECEP√á√ÉO</td><td class="num">124</td></tr>
          <tr><td>ERRO MULTIDISCIPLINAR</td><td class="num">1</td></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Pareto de causas (compacto + visual) -->
  <div class="grid-2">
    <div class="section">
      <h2 class="section-title">üìä Pareto de causas (top 15)</h2>
      <p class="section-sub">acumulado sobre 4.885 erros</p>
      <div class="table-wrapper" style="max-height:300px;">
        <table>
          <thead><tr><th>Causa</th><th class="num">Erros</th><th class="num">%</th><th>% acum.</th></tr></thead>
          <tbody>
            <tr><td>MATERIAL N√ÉO COBRADO</td><td class="num">1.380</td><td class="num">28,25%</td><td><div class="progress-bar"><div class="bar-bg"><div class="bar" style="width:28.25%"></div></div>28,3%</div></td></tr>
            <tr><td>MEDICA√á√ÉO N√ÉO COBRADA</td><td class="num">1.099</td><td class="num">22,50%</td><td>50,8%</td></tr>
            <tr><td>FALTA IMPRESS√ÉO CENTRO CIRURGICO</td><td class="num">596</td><td class="num">12,20%</td><td>63,0%</td></tr>
            <tr><td>COBRAN√áA INDEVIDA</td><td class="num">482</td><td class="num">9,87%</td><td>72,8%</td></tr>
            <tr><td>N√ÉO COBRADO TX ALIMENTA√á√ÉO</td><td class="num">183</td><td class="num">3,75%</td><td>76,6%</td></tr>
            <tr><td>FALTA IMPRESS√ÉO EVOLU√á√ÉO M√âDICA</td><td class="num">146</td><td class="num">2,99%</td><td>79,6%</td></tr>
            <tr><td>COBRAN√áA INDEVIDA (2)</td><td class="num">86</td><td class="num">1,76%</td><td>81,3%</td></tr>
            <tr><td>FALTA COBRAR FIO CIRURGICO</td><td class="num">86</td><td class="num">1,76%</td><td>83,1%</td></tr>
            <tr><td>FALTA IMPRESS√ÉO RELAT√ìRIO ENFERMAGEM</td><td class="num">83</td><td class="num">1,70%</td><td>84,8%</td></tr>
            <tr><td>GUIA SEM ASSINATURA</td><td class="num">72</td><td class="num">1,47%</td><td>86,3%</td></tr>
            <tr><td>‚Ä¶ (mais 5)</td><td class="num">248</td><td class="num">5,08%</td><td>100%</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <h2 class="section-title">üë§ Respons√°veis (top 10)</h2>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Respons√°vel</th><th class="num">Erros</th></tr></thead>
          <tbody>
            <tr><td>BRUNO TAVARES</td><td class="num">2.324</td></tr>
            <tr><td>KATIA ALVES</td><td class="num">1.064</td></tr>
            <tr><td>SABRYNA GABRIELLA</td><td class="num">803</td></tr>
            <tr><td>LEDISMAR</td><td class="num">164</td></tr>
            <tr><td>WARLEY</td><td class="num">139</td></tr>
            <tr><td>LORENA</td><td class="num">88</td></tr>
            <tr><td>KALITA OLIVEIRA LISBOA</td><td class="num">12</td></tr>
            <tr><td>ANA KAROLINA</td><td class="num">8</td></tr>
            <tr><td>RENATO MARINHO</td><td class="num">4</td></tr>
            <tr><td>JUNICHIRO</td><td class="num">3</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pr√≥ximos passos -->
  <div class="section">
    <h2 class="section-title">‚è© Pr√≥ximos passos (executivo)</h2>
    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem;">
      <div style="background:rgba(0,0,0,0.2); border-radius:1.2rem; padding:1.2rem;">
        <div style="color:#2dd4bf; font-weight:600;">üìÖ 1. Padronizar datas</div>
        <p style="color:var(--text-secondary); font-size:0.9rem; margin-top:0.5rem;">Recebimento, fim auditoria e faturamento sem invers√µes.</p>
      </div>
      <div style="background:rgba(0,0,0,0.2); border-radius:1.2rem; padding:1.2rem;">
        <div style="color:#3b82f6; font-weight:600;">üìÅ 2. Completar dicion√°rios</div>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Preencher categoria_erro e vincular em erro.categoria_erro_id.</p>
      </div>
      <div style="background:rgba(0,0,0,0.2); border-radius:1.2rem; padding:1.2rem;">
        <div style="color:#f59e0b; font-weight:600;">üéØ 3. Plano 80/20</div>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Atacar as 3‚Äì5 causas l√≠deres do Pareto com metas mensais.</p>
      </div>
      <div style="background:rgba(0,0,0,0.2); border-radius:1.2rem; padding:1.2rem;">
        <div style="color:#f43f5e; font-weight:600;">üìâ 4. Metas por setor/conv√™nio</div>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Reduzir erros por prontu√°rio e % com erro.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Painel executivo ¬∑ gerado a partir do auditoria.db ¬∑ dados atualizados em fevereiro/2026
  </div>
</div>

<script>
  (function() {
    // Dados mensais completos
    const monthData = [
      { month: '2025-10', pront: 87, comErro: 87, erros: 438, errosPorPront: 5.03 },
      { month: '2025-11', pront: 182, comErro: 153, erros: 643, errosPorPront: 3.53 },
      { month: '2025-12', pront: 348, comErro: 313, erros: 2125, errosPorPront: 6.11 },
      { month: '2026-01', pront: 206, comErro: 194, erros: 1179, errosPorPront: 5.72 },
      { month: '2026-02', pront: 16, comErro: 15, erros: 72, errosPorPront: 4.50 }
    ];

    const totalGlobal = { pront: 1017, comErro: 940, erros: 4885, errosPorPront: 4.80 };

    // Elementos
    const filterButtons = document.querySelectorAll('.filter-btn');
    const trendRows = document.querySelectorAll('#trendTable tbody tr');
    const kpiPront = document.getElementById('kpiProntuarios');
    const kpiComErro = document.getElementById('kpiComErro');
    const kpiErros = document.getElementById('kpiErros');
    const kpiErrosPorPront = document.getElementById('kpiErrosPorPront');
    const filtroNome = document.getElementById('filtroNome');
    const filtroPront = document.getElementById('filtroPront');
    const filtroErr = document.getElementById('filtroErr');
    const compareContainer = document.getElementById('compareContainer');
    const callout = document.getElementById('calloutCompare');

    let currentMonth = 'all';

    function updateFilterUI(activeMonth) {
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.month === activeMonth) btn.classList.add('active');
      });
    }

    function getMonthData(month) {
      return monthData.find(m => m.month === month) || null;
    }

    function getPreviousMonth(month) {
      const index = monthData.findIndex(m => m.month === month);
      return index > 0 ? monthData[index-1] : null;
    }

    function formatNumber(num) {
      return num.toLocaleString('pt-BR');
    }

    function updateDisplay() {
      // 1. Filtrar linhas da tabela de tend√™ncia
      let visibleMonths = [];
      trendRows.forEach(row => {
        const month = row.dataset.month;
        if (currentMonth === 'all' || month === currentMonth) {
          row.style.display = '';
          visibleMonths.push(month);
        } else {
          row.style.display = 'none';
        }
      });

      // 2. Calcular totais filtrados (soma dos meses vis√≠veis)
      let filtrados = monthData.filter(m => currentMonth === 'all' || m.month === currentMonth);
      let totalPront = filtrados.reduce((acc, m) => acc + m.pront, 0);
      let totalErros = filtrados.reduce((acc, m) => acc + m.erros, 0);
      let totalComErro = filtrados.reduce((acc, m) => acc + m.comErro, 0);
      let mediaErrosPorPront = totalPront ? (totalErros / totalPront).toFixed(2) : '0,00';

      // Se for "Todos", mostra totais globais
      if (currentMonth === 'all') {
        totalPront = totalGlobal.pront;
        totalErros = totalGlobal.erros;
        totalComErro = totalGlobal.comErro;
        mediaErrosPorPront = totalGlobal.errosPorPront.toFixed(2).replace('.', ',');
      }

      kpiPront.innerText = formatNumber(totalPront);
      kpiComErro.innerText = formatNumber(totalComErro);
      kpiErros.innerText = formatNumber(totalErros);
      kpiErrosPorPront.innerText = mediaErrosPorPront;

      filtroNome.innerText = currentMonth === 'all' ? 'Todos os meses' : currentMonth.replace('-', '/');
      filtroPront.innerText = formatNumber(totalPront);
      filtroErr.innerText = formatNumber(totalErros);

      // 3. Atualizar cards comparativos
      if (currentMonth === 'all') {
        // Mostra Dez vs Jan como padr√£o
        let dez = getMonthData('2025-12');
        let jan = getMonthData('2026-01');
        renderCompareCards(dez, jan);
        callout.innerHTML = `<b>Leitura r√°pida:</b> de Dez/2025 para Jan/2026, houve varia√ß√£o de <b>${(jan.erros - dez.erros) > 0 ? '+' : ''}${(jan.erros - dez.erros)}</b> erros, taxa de pront. c/ erro ${((jan.comErro/jan.pront*100) - (dez.comErro/dez.pront*100)).toFixed(2)} p.p.`;
      } else {
        let current = getMonthData(currentMonth);
        let previous = getPreviousMonth(currentMonth);
        if (current) {
          renderCompareCards(previous, current);
          if (previous) {
            let varErros = current.erros - previous.erros;
            let varPercentPront = ((current.comErro/current.pront) - (previous.comErro/previous.pront)) * 100;
            callout.innerHTML = `<b>An√°lise:</b> ${currentMonth.replace('-','/')} vs ${previous.month.replace('-','/')} ¬∑ erros: ${varErros > 0 ? '+' : ''}${varErros} ¬∑ % c/ erro: ${varPercentPront > 0 ? '+' : ''}${varPercentPront.toFixed(2)} p.p.`;
          } else {
            callout.innerHTML = `<b>M√™s inicial:</b> n√£o h√° m√™s anterior para compara√ß√£o.`;
          }
        }
      }
    }

    function renderCompareCards(prev, curr) {
      if (!curr) return;
      let prevHtml = prev ? `
        <div class="compare-card">
          <h3>${prev.month.replace('-', '/')}</h3>
          <div class="compare-metrics">
            <div class="metric"><small>Prontu√°rios</small><div class="value">${prev.pront}</div></div>
            <div class="metric"><small>Erros</small><div class="value">${prev.erros}</div></div>
            <div class="metric"><small>% c/ erro</small><div class="value">${(prev.comErro/prev.pront*100).toFixed(1)}%</div></div>
            <div class="metric"><small>Erros/pront.</small><div class="value">${prev.errosPorPront.toFixed(2)}</div></div>
          </div>
        </div>
      ` : `<div class="compare-card"><h3>M√™s anterior</h3><p style="color:var(--text-secondary)">Sem dados</p></div>`;

      let currHtml = `
        <div class="compare-card" style="border-color:#2dd4bf;">
          <h3 style="color:#2dd4bf;">${curr.month.replace('-', '/')} (selecionado)</h3>
          <div class="compare-metrics">
            <div class="metric"><small>Prontu√°rios</small><div class="value">${curr.pront}</div></div>
            <div class="metric"><small>Erros</small><div class="value">${curr.erros}</div></div>
            <div class="metric"><small>% c/ erro</small><div class="value">${(curr.comErro/curr.pront*100).toFixed(1)}%</div></div>
            <div class="metric"><small>Erros/pront.</small><div class="value">${curr.errosPorPront.toFixed(2)}</div></div>
          </div>
        </div>
      `;

      compareContainer.innerHTML = prevHtml + currHtml;
    }

    // Event listeners
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentMonth = btn.dataset.month;
        updateFilterUI(currentMonth);
        updateDisplay();
      });
    });

    // Inicializa
    updateDisplay();
  })();
</script>
</body>
</html>
